<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DARI Photo Booth â€“ Kiosk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- PWA hooks â€“ keep the /dari-photobooth path for GitHub Pages -->
  <meta name="theme-color" content="#3c463f" />
  <link rel="manifest" href="/dari-photobooth/manifest.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DARI Booth" />
  <link rel="apple-touch-icon" href="/dari-photobooth/icon-192.png" />

  <!-- Montserrat font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e7e1d5;
      color: #222;
      display: flex;
      flex-direction: column;
      /* overflow: hidden;  <-- removed so QR/page bottom won't be clipped */
    }

    header {
      background: #3c463f;
      color: #fff;
      padding: 14px;
      text-align: center;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 2px;
    }

    /* main layout: single column, centered */
    .main-shell {
      flex: 1 1 auto;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 8px;
      box-sizing: border-box;
      overflow-y: auto;  /* allow vertical scroll if QR/strip is tall */
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .previewWrapper {
      position: relative;
      width: 100%;
      flex: 1 1 auto;
      min-height: 280px;
      max-height: 65vh;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }

    #cameraPreview,
    #canvasOutput {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #canvasOutput {
      display: none;
      object-fit: contain;
      background: #111;
    }

    /* overlays */
    #frameOverlay,
    #previewLogo,
    #flashOverlay,
    #countdownOverlay {
      position: absolute;
      pointer-events: none;
    }

    #frameOverlay {
      inset: 0;
      border: none;
      z-index: 2;
    }

    .previewWrapper.frame-minimal #frameOverlay {
      border: 6px solid #DFD7C9;
    }
    .previewWrapper.frame-signature #frameOverlay {
      border: 6px solid #6b1e1e;
    }

    #previewLogo {
      top: 14px;
      right: 14px;
      width: 22%;
      height: auto;
      z-index: 3;
    }

    #flashOverlay {
      inset: 0;
      background: #ffffff;
      opacity: 0;
      transition: opacity 0.15s ease-out;
      z-index: 5;
    }

    #flashOverlay.active {
      opacity: 1;
    }

    #countdownOverlay {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 64px;
      font-weight: 700;
      color: white;
      text-shadow: 0 0 10px rgba(0,0,0,0.8);
      z-index: 6;
    }

    .statusText {
      font-size: 14px;
      text-align: center;
      min-height: 18px;
      color: #444;
    }

    /* LIVE VIEW CONTROLS ROW */
    .live-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: stretch;
    }

    .live-controls select,
    .live-controls button {
      flex: 1 1 0;
      min-width: 0;
    }

    /* RESULT CONTROLS ROW (after strip) */
    .result-controls {
      display: none; /* hidden until strip is ready */
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: stretch;
      margin-top: 4px;
    }

    .result-controls button {
      flex: 1 1 0;
      min-width: 0;
    }

    select,
    button {
      padding: 12px 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      box-sizing: border-box;
      font-family: "Montserrat", system-ui, sans-serif;
    }

    select {
      border: 1px solid #c0b8aa;
      background: white;
    }

    button {
      background: #6b1e1e;
      color: white;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
    }

    button.secondaryBtn {
      background: white;
      color: #3c463f;
      border: 1px solid #3c463f;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* QR panel â€“ small & only when needed */
    #qrPanel {
      display: none;
      margin: 6px auto 12px;
      padding: 10px;
      background: white;
      border-radius: 10px;
      border: 2px solid #3c463f;
      max-width: 320px;
      text-align: center;
      box-sizing: border-box;
    }

    #qrCode {
      width: 140px;
      height: 140px;
      margin: 4px auto;
    }

    .qrHint {
      font-size: 12px;
      color: #555;
    }

    .qrClose {
      margin-top: 4px;
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
      color: #6b1e1e;
    }

    /* ATTRACT SCREEN */
    #attractScreen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #f3e7da, #dfd3c2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 24px;
      text-align: center;
      box-sizing: border-box;
    }

    #attractLogo {
      max-width: 260px;
      margin-bottom: 20px;
    }

    #attractTitle {
      color: #3c463f;
      font-size: 26px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    #attractSub {
      color: #6b1e1e;
      font-size: 16px;
      margin-bottom: 32px;
    }

    #attractButton {
      background: #6b1e1e;
      color: white;
      padding: 16px 32px;
      border: none;
      border-radius: 999px;
      font-size: 20px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(0,0,0,0.25);
    }

    #attractHint {
      font-size: 12px;
      color: #444;
      margin-top: 20px;
    }
  </style>

  <!-- QR library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <header>DARI PHOTO BOOTH</header>

  <!-- ATTRACT SCREEN -->
  <div id="attractScreen">
    <img id="attractLogo" src="dari-logo-filled.png" alt="DARI Logo" />
    <div id="attractTitle">DAILY RITUAL PH</div>
    <div id="attractSub">Tap to start your photo strip</div>
    <button id="attractButton">Tap to Start</button>
    <div id="attractHint">Make sure the tablet camera is uncovered and volume is up for the countdown.</div>
  </div>

  <!-- MAIN APP -->
  <div class="main-shell" id="appShell" style="visibility:hidden;">
    <div class="app">
      <div class="previewWrapper frame-none" id="previewWrapper">
        <video id="cameraPreview" autoplay playsinline></video>
        <canvas id="canvasOutput"></canvas>

        <div id="frameOverlay"></div>
        <img id="previewLogo" src="dari-logo-outline.png" alt="DARI logo preview" />
        <div id="flashOverlay"></div>
        <div id="countdownOverlay"></div>
      </div>

      <div class="statusText" id="statusText"></div>

      <!-- LIVE VIEW CONTROLS (visible while camera live) -->
      <div class="live-controls" id="liveControls">
        <select id="filterSelect">
          <option value="none">No Filter</option>
          <option value="grayscale(1)">Black & White</option>
          <option value="sepia(1)">Sepia</option>
          <option value="contrast(1.3) saturate(1.1)">Vivid</option>
        </select>

        <select id="frameSelect">
          <option value="none">Plain (white)</option>
          <option value="minimal">Minimal (cream)</option>
          <option value="signature">Signature (red)</option>
        </select>

        <button id="startBtn">Start</button>
      </div>

      <!-- RESULT CONTROLS (visible when strip is shown) -->
      <div class="result-controls" id="resultControls">
        <button id="retakeBtn" class="secondaryBtn">Retake</button>
        <button id="downloadBtn" class="secondaryBtn">Download / QR</button>
        <button id="printBtn">Print</button>
      </div>

      <!-- Small QR panel, shown only after Download press -->
      <div id="qrPanel">
        <div id="qrCode"></div>
        <div class="qrHint">Scan to download your strip.</div>
        <div class="qrClose" id="qrClose">Hide</div>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   BASIC DOM & STATE
------------------------------*/
const video = document.getElementById("cameraPreview");
const canvas = document.getElementById("canvasOutput");
const ctx = canvas.getContext("2d");

const statusText = document.getElementById("statusText");
const countdownOverlay = document.getElementById("countdownOverlay");
const flashOverlay = document.getElementById("flashOverlay");
const previewWrapper = document.getElementById("previewWrapper");
const frameOverlay = document.getElementById("frameOverlay");
const previewLogo = document.getElementById("previewLogo");

const filterSelect = document.getElementById("filterSelect");
const frameSelect = document.getElementById("frameSelect");
const startBtn = document.getElementById("startBtn");

const resultControls = document.getElementById("resultControls");
const liveControls = document.getElementById("liveControls");
const retakeBtn = document.getElementById("retakeBtn");
const downloadBtn = document.getElementById("downloadBtn");
const printBtn = document.getElementById("printBtn");

const qrPanel = document.getElementById("qrPanel");
const qrBox = document.getElementById("qrCode");
const qrClose = document.getElementById("qrClose");

const attractScreen = document.getElementById("attractScreen");
const attractButton = document.getElementById("attractButton");
const appShell = document.getElementById("appShell");

const TOTAL_SHOTS = 3;
const STRIP_WIDTH = 384; // approx for 53mm printer

let cameraStream = null;
let stripImages = [];
let isCapturing = false;
let lastUploadedUrl = null;

// idle â†’ go back to attract
const IDLE_TIMEOUT_MS = 90000;
let idleTimer = null;

/* Cloudinary */
const CLOUDINARY_CLOUD_NAME = "dari-cafe";
const CLOUDINARY_UPLOAD_PRESET = "dari-booth-unsigned";

function cloudinaryConfigured() {
  return (
    CLOUDINARY_CLOUD_NAME &&
    CLOUDINARY_UPLOAD_PRESET &&
    !CLOUDINARY_CLOUD_NAME.includes("YOUR_") &&
    !CLOUDINARY_UPLOAD_PRESET.includes("YOUR_")
  );
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/* -----------------------------
   CAMERA
------------------------------*/
async function initCamera() {
  if (cameraStream) return;
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: false
    });
    video.srcObject = cameraStream;
    statusText.textContent = "Camera ready. Tap â€œStartâ€.";
  } catch (err) {
    console.error(err);
    statusText.textContent =
      "Camera access failed: " + err.name + " â€“ check browser permissions.";
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
    video.srcObject = null;
  }
}

/* -----------------------------
   IMAGE HELPERS
------------------------------*/
function loadImageFromDataUrl(dataUrl) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = dataUrl;
  });
}

function loadLogo(filename) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = filename;
  });
}

/* -----------------------------
   FRAME PREVIEW
------------------------------*/
function updateFramePreview() {
  const frame = frameSelect.value;
  previewWrapper.classList.remove("frame-none", "frame-minimal", "frame-signature");

  if (frame === "minimal") {
    previewWrapper.classList.add("frame-minimal");
    previewLogo.src = "dari-logo-filled.png";
  } else if (frame === "signature") {
    previewWrapper.classList.add("frame-signature");
    previewLogo.src = "dari-logo-outline-transparent.png";
  } else {
    previewWrapper.classList.add("frame-none");
    previewLogo.src = "dari-logo-outline.png";
  }
}
frameSelect.addEventListener("change", () => { updateFramePreview(); resetIdleTimer(); });
filterSelect.addEventListener("change", resetIdleTimer);

/* -----------------------------
   IDLE â†’ ATTRACT
------------------------------*/
function resetIdleTimer() {
  if (idleTimer) clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    goToAttract();
  }, IDLE_TIMEOUT_MS);
}

function goToBooth() {
  attractScreen.style.display = "none";
  appShell.style.visibility = "visible";
  initCamera();
  resetIdleTimer();
}

function goToAttract() {
  stopCamera();
  stripImages = [];
  lastUploadedUrl = null;

  video.style.display = "block";
  canvas.style.display = "none";

  liveControls.style.display = "flex";
  resultControls.style.display = "none";
  qrPanel.style.display = "none";

  startBtn.disabled = false;
  statusText.textContent = "";

  attractScreen.style.display = "flex";
}

/* -----------------------------
   CAPTURE FLOW
------------------------------*/
startBtn.addEventListener("click", async () => {
  resetIdleTimer();
  if (isCapturing || !cameraStream) return;

  isCapturing = true;
  stripImages = [];
  lastUploadedUrl = null;
  qrPanel.style.display = "none";

  liveControls.style.display = "none";       // hide controls while capturing
  resultControls.style.display = "none";

  statusText.textContent = "Get readyâ€¦";

  canvas.style.display = "none";
  video.style.display = "block";

  for (let shot = 1; shot <= TOTAL_SHOTS; shot++) {
    statusText.textContent = `Photo ${shot} of ${TOTAL_SHOTS}`;

    for (let c = 3; c >= 1; c--) {
      countdownOverlay.textContent = c;
      await sleep(700);
    }
    countdownOverlay.textContent = "ðŸ“¸";

    flashOverlay.classList.add("active");
    await sleep(120);
    flashOverlay.classList.remove("active");
    await sleep(80);

    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) continue;

    const filter = filterSelect.value;
    canvas.width = w;
    canvas.height = h;

    ctx.filter = (filter === "none") ? "none" : filter;
    ctx.drawImage(video, 0, 0, w, h);
    ctx.filter = "none";

    stripImages.push(canvas.toDataURL("image/jpeg", 0.95));

    countdownOverlay.textContent = "";
    await sleep(250);
  }

  await buildStrip();
  isCapturing = false;
});

/* -----------------------------
   BUILD STRIP (3 shots)
------------------------------*/
async function buildStrip() {
  if (!stripImages.length) return;

  let photos;
  try {
    photos = await Promise.all(stripImages.map(loadImageFromDataUrl));
  } catch (e) {
    console.error(e);
    statusText.textContent = "Error building strip, please try again.";
    return;
  }

  const frame = frameSelect.value;
  const stripWidth = STRIP_WIDTH;
  const topMargin = 30;
  const singleHeight = 220;
  const gap = 12;

  const photosTotalHeight = TOTAL_SHOTS * singleHeight + (TOTAL_SHOTS - 1) * gap;
  const brandingHeight = 220;
  const bottomMargin = 40;
  const brandingTop = topMargin + photosTotalHeight + 20;
  const stripHeight = brandingTop + brandingHeight + bottomMargin;

  canvas.width = stripWidth;
  canvas.height = stripHeight;

  let baseBg = "#ffffff";
  if (frame === "minimal") baseBg = "#DFD7C9";
  if (frame === "signature") baseBg = "#6b1e1e";

  ctx.fillStyle = baseBg;
  ctx.fillRect(0, 0, stripWidth, stripHeight);

  if (frame === "signature") {
    const cardMarginX = 18;
    const cardTop = topMargin - 10;
    const cardHeight = photosTotalHeight + 20;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(cardMarginX, cardTop, stripWidth - cardMarginX * 2, cardHeight);
  }

  let y = topMargin;
  photos.forEach(p => {
    const x = 20;
    const w = stripWidth - 40;
    ctx.drawImage(p, x, y, w, singleHeight);
    y += singleHeight + gap;
  });

  let logoFile = "dari-logo-outline.png";
  if (frame === "minimal") logoFile = "dari-logo-filled.png";
  if (frame === "signature") logoFile = "dari-logo-outline-transparent.png";

  const textColor = (frame === "signature") ? "#ffffff" : "#374139";

  const now = new Date();
  const dateStr = now.toLocaleDateString("en-US", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  });

  try {
    const logoImg = await loadLogo(logoFile);
    let desiredWidth = stripWidth * 0.5;
    let ratio = logoImg.height / logoImg.width;
    let logoW = desiredWidth;
    let logoH = desiredWidth * ratio;

    const maxLogoHeight = brandingHeight * 0.5;
    if (logoH > maxLogoHeight) {
      const scale = maxLogoHeight / logoH;
      logoW *= scale;
      logoH *= scale;
    }

    const logoX = (stripWidth - logoW) / 2;
    const logoY = brandingTop + 10;
    ctx.drawImage(logoImg, logoX, logoY, logoW, logoH);

    ctx.fillStyle = textColor;
    ctx.textAlign = "center";
    ctx.font = "600 24px 'Montserrat', system-ui, sans-serif";

    const textY = logoY + logoH + 32;
    const maxTextY = brandingTop + brandingHeight - 40;
    const safeTextY = Math.min(textY, maxTextY);
    ctx.fillText("Daily Ritual PH", stripWidth / 2, safeTextY);

    ctx.save();
    ctx.fillStyle = textColor;
    ctx.font = "500 16px 'Montserrat', system-ui, sans-serif";
    const dateBaseX = stripWidth - 28;
    const dateBaseY = stripHeight - 90;
    ctx.translate(dateBaseX, dateBaseY);
    ctx.rotate(-Math.PI / 2);
    ctx.textAlign = "center";
    ctx.fillText(dateStr, 0, 0);
    ctx.restore();
  } catch (e) {
    console.warn("Logo failed to load:", e);
  }

  if (frame === "minimal") {
    ctx.strokeStyle = "#374139";
    ctx.lineWidth = 10;
    ctx.strokeRect(10, 10, stripWidth - 20, stripHeight - 20);
  }
  if (frame === "signature") {
    ctx.strokeStyle = "#4f1414";
    ctx.lineWidth = 8;
    ctx.strokeRect(6, 6, stripWidth - 12, stripHeight - 12);
  }

  // show strip
  video.style.display = "none";
  canvas.style.display = "block";

  liveControls.style.display = "none";
  resultControls.style.display = "flex";

  retakeBtn.disabled = false;
  printBtn.disabled = false;

  statusText.textContent = "Strip ready! You can retake, print, or tap Download for QR.";

  // start upload in background so QR is ready when asked
  uploadStripToCloudinary();
}

/* -----------------------------
   CLOUDINARY & QR
------------------------------*/
function uploadStripToCloudinary(onSuccess) {
  if (!cloudinaryConfigured()) {
    statusText.textContent += " (Cloudinary not configured, QR disabled.)";
    return;
  }

  canvas.toBlob(async (blob) => {
    try {
      const url =
        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
      const formData = new FormData();
      formData.append("file", blob);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const res = await fetch(url, { method: "POST", body: formData });
      const data = await res.json();
      const fileUrl = data.secure_url || data.url;
      if (!fileUrl) throw new Error("No URL in Cloudinary response");

      lastUploadedUrl = fileUrl;
      if (onSuccess) onSuccess(fileUrl);
    } catch (err) {
      console.error(err);
      statusText.textContent = "Strip ready. QR upload failed.";
    }
  }, "image/jpeg");
}

function showQRCode(url) {
  if (!url) return;
  qrPanel.style.display = "block";
  qrBox.innerHTML = "";
  new QRCode(qrBox, {
    text: url,
    width: 140,
    height: 140
  });
}

downloadBtn.addEventListener("click", () => {
  resetIdleTimer();
  if (lastUploadedUrl) {
    showQRCode(lastUploadedUrl);
  } else {
    uploadStripToCloudinary(showQRCode);
  }
});

qrClose.addEventListener("click", () => {
  qrPanel.style.display = "none";
});

/* -----------------------------
   RETAKE & PRINT
------------------------------*/
retakeBtn.addEventListener("click", () => {
  resetIdleTimer();
  stripImages = [];
  lastUploadedUrl = null;
  qrPanel.style.display = "none";

  canvas.style.display = "none";
  video.style.display = "block";

  liveControls.style.display = "flex";
  resultControls.style.display = "none";

  statusText.textContent = "Camera ready. Tap â€œStartâ€ again.";
});

printBtn.addEventListener("click", () => {
  resetIdleTimer();
  const img = canvas.toDataURL("image/jpeg", 0.95);
  const win = window.open("", "_blank");
  win.document.write(`
    <html>
      <head>
        <title>DARI Strip</title>
        <style>
          @page { margin: 0; }
          body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
          }
          img { width: 53mm; }
        </style>
      </head>
      <body>
        <img src="${img}" />
      </body>
    </html>
  `);
  win.document.close();
  win.focus();
  win.onload = () => win.print();
});

/* -----------------------------
   ATTRACT EVENTS & LOAD
------------------------------*/
attractButton.addEventListener("click", () => {
  goToBooth();
});

["click", "touchstart", "pointerdown", "keydown"].forEach(evt => {
  window.addEventListener(evt, resetIdleTimer);
});

window.addEventListener("load", () => {
  appShell.style.visibility = "visible";
  attractScreen.style.display = "flex";
  updateFramePreview();
});
</script>

</body>
</html>
